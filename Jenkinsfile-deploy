def getDeploymentServer(branch) {
    switch (branch) {
        case ~/^master$/:
            return ''
        case ~/^develop$/:
            return COA_IP
	default:
            return COA_IP
    }
}

pipeline {
  agent { 
    docker { 
      image 'node:12.11.1' 
      args  '-u 0:0'
    } 
  }

  environment {
    SLACK_TOKEN = credentials('slack_token')
    COA_IP = credentials('COA_staging')
  }

  stages {
    stage("checkout") {
      steps {
        checkout scm
      }
    }

    stage("upload") {
      steps {
        script {
          GIT_BRANCH = sh (
                  script: 'git rev-parse --abbrev-ref HEAD',
                  returnStdout: true
                ).trim()
          withEnv(['DEPLOY_SERVER=' + getDeploymentServer(GIT_BRANCH), 'SERVE_DIR=/home/circles-of-angels-api', 'BUILDS_DIR=/home/builds/circles-of-angels-api']) {
            sshagent(credentials: ['ssh_jenkins_global'], ignoreMissing: true) {
              sh '''ssh -oStrictHostKeyChecking=no ${DEPLOY_SERVER} "
                    export PATH=/root/.nvm/versions/node/v10.15.1/bin:$PATH
                    pm2 delete back
                    rm -r ${SERVE_DIR}/node_modules ${SERVE_DIR}/package-lock.json
                    mkdir /home/backup-configs
                    cp -r ${SERVE_DIR}/config/* /home/backup-configs;
                    cp -aL ${SERVE_DIR} ${BUILDS_DIR}/$BUILD_NUMBER;
                    "
                '''

              sh '''rsync -av -e "ssh -oStrictHostKeyChecking=no" ${WORKSPACE}/* ${DEPLOY_SERVER}:${SERVE_DIR}/'''
     
              sh '''ssh -oStrictHostKeyChecking=no ${DEPLOY_SERVER} "
    		   pm2 restart circles-of-angels-api
                   "
                 '''
            }
	  }
	}
      }
    }
    stage("Notify on slack") {
      steps {
        script {

          MSG = "New Backend deployed!"
          TO_POST = """
            {
              "text": "${MSG}",
              "icon_emoji": ":gentlemanparrot:",
              "channel": "CFN40LX55"
            }
          """
          httpRequest acceptType: 'APPLICATION_JSON', contentType: 'APPLICATION_JSON', httpMode: 'POST', requestBody: TO_POST, url: ('https://atixlabs.slack.com/services/hooks/incoming-webhook?token=' + SLACK_TOKEN)
        }

      }
    }
  }
}


